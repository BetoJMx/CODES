--QRY OK CHEQUES 0
WITH cat_elements_indem AS (
    SELECT  meaning AS element_name,
            description element_name_reporte
    FROM    fnd_lookup_values
    WHERE   1 = 1
            AND TRIM(lookup_type)   = 'XXGRG_INDEMN_RECIBO_FIN_CFDI'
            AND TAG                 = 'SUMA_FINIQUITO'
            AND language            = SYS_CONTEXT('USERENV','LANG')
            AND enabled_flag        = 'Y'
    UNION
    SELECT  meaning AS element_name,
            description element_name_reporte
    FROM    fnd_lookup_values
    WHERE   1 = 1
            AND TRIM(lookup_type)   = 'XXGRG_INDEMN_RECIBO_FIN_CFDI'
            AND TAG                 IN ('RETIRO_VOLUNTARIO','FONDO_AHORRO','INTERESES')
            AND language            = SYS_CONTEXT('USERENV','LANG')
            AND enabled_flag        = 'Y' 
),
cat_element_percep AS (
    SELECT  meaning AS element_name,
            description element_name_reporte
    FROM    fnd_lookup_values
    WHERE   1 = 1
            AND TRIM(lookup_type)   = 'XXGRG_PERCEP_RECIBO_FIN_CFDI'
            AND language            = SYS_CONTEXT('USERENV','LANG')
            AND enabled_flag        = 'Y'
),
cat_elements_ded AS (
    SELECT  meaning AS element_name,
            description element_name_reporte
    FROM    fnd_lookup_values
    WHERE   1 = 1
            AND TRIM(lookup_type)   = 'XXGRG_DEDUC_RECIBO_FIN_CFDI'
            AND description NOT     IN (
                                        'DIAS POR AÃ‘O TRABAJADO',
                                        'PRIMA DE ANTIGUEDAD',
                                        'MESES POR SEPARACION',
                                        'PAGO POR SEPARACION',
                                        'RETIRO VOLUNTARIO PAGADO'
                                       )
            AND language            = SYS_CONTEXT('USERENV','LANG')
            AND enabled_flag        = 'Y'
    UNION
    SELECT  meaning AS element_name,
            description element_name_reporte
    FROM    fnd_lookup_values
    WHERE   1 = 1
            AND TRIM(lookup_type)   = 'XXGRG_INDEMN_RECIBO_FIN_CFDI'
            AND TAG                 = 'RESTA_FINIQUITO'
            AND language            = SYS_CONTEXT('USERENV','LANG')
            AND enabled_flag        = 'Y' 
),
cat_diferencia_fondo_ahorro AS (
    SELECT  meaning AS element_name,
            description element_name_reporte
    FROM    fnd_lookup_values
    WHERE   1 = 1
            AND TRIM(lookup_type)   = 'XXGRG_INDEMN_RECIBO_FIN_CFDI'
            AND TAG                 = 'DIFERENCIA_CAJA_AHORRO'
            AND language            = SYS_CONTEXT('USERENV','LANG')
            AND enabled_flag        = 'Y'
),
total_indem AS(
    SELECT  importe total_indem,
            payroll_rel_action_id
    FROM    (
                SELECT  SUM(importe) importe,
                        payroll_rel_action_id
                FROM    (
                            SELECT  CASE
                                        WHEN input_name <> 'ISR EXEMPT' AND input_name <> 'ISR SUBJECT' THEN
                                            result_value
                                        ELSE
                                            0
                                    END importe,
                                    payroll_rel_action_id
                            FROM    (            
                                        SELECT  UPPER(TRIM(pivtl.name)) input_name,
                                                CASE 
                                                    WHEN UPPER (TRIM (pec.base_classification_name)) = 'SOCIAL INSURANCE DEDUCTIONS' AND UPPER(TRIM(pivtl.name)) = 'SDI' AND prtf.shortname <> 'REGNOR' THEN
                                                        0
                                                    ELSE        
                                                        ABS(SUM(prrv.result_value))
                                                END AS result_value,
                                                ppra.payroll_rel_action_id                              
                                        FROM    pay_payroll_rel_actions         ppra,
                                                pay_run_types_f                 prtf,
                                                pay_run_results                 prr,
                                                pay_run_result_values           prrv,
                                                pay_element_types_f             pet,
                                                pay_element_types_tl            pettl,
                                                fusion.pay_ele_classifications  pec,
                                                fusion.pay_input_values_f       piv,
                                                pay_input_values_tl             pivtl,
                                                cat_elements_indem              elem
                                        WHERE   1 = 1
                                                AND ppra.run_type_id            = prtf.run_type_id
                                                AND ppra.payroll_rel_action_id  = prr.payroll_rel_action_id
                                                AND prr.run_result_id           = prrv.run_result_id
                                                AND prr.status                  IN ('P', 'PA')
                                                AND prr.element_type_id         = pet.element_type_id
                                                AND pet.element_type_id         = pettl.element_type_id
                                                AND pet.classification_id       = pec.classification_id
                                                AND pet.element_type_id         = piv.element_type_id
                                                AND prrv.input_value_id         = piv.input_value_id
                                                AND piv.input_value_id          = pivtl.input_value_id
                                                AND piv.user_display_flag       = 'Y'
                                                AND UPPER(pettl.element_name)   = UPPER(elem.element_name)
                                                AND (    
                                                        (     
                                                            UPPER (pec.base_classification_name) IN (  
                                                                                                        'STANDARD EARNINGS',
                                                                                                        'SUPPLEMENTAL EARNINGS',
                                                                                                        'TAXABLE BENEFITS'
                                                                                                    )
                                                            AND UPPER (TRIM (pivtl.name)) IN (  
                                                                                                'PAY VALUE',
                                                                                                'VALOR PAGO',
                                                                                                'EARNINGS CALCULATED',
                                                                                                'ISR SUBJECT',
                                                                                                'ISR EXEMPT'
                                                                                             )
                                                        )
                                                        OR  (   
                                                                (    
                                                                    UPPER (pec.base_classification_name) IN (  
                                                                                                                'TAX DEDUCTIONS',
                                                                                                                'SOCIAL INSURANCE DEDUCTIONS',
                                                                                                                'EMPLOYER TAXES'
                                                                                                            )
                                                                    AND UPPER (TRIM (pivtl.name)) IN (  
                                                                                                        'EMPLOYER SOCIAL SECURITY QUOTA',
                                                                                                        'SDI',
                                                                                                        'PAY VALUE',
                                                                                                        'VALOR PAGO',
                                                                                                        'ISR WITHHELD',
                                                                                                        'ISR SUBSIDY FOR EMPLOYMENT PAID',
                                                                                                        'ISR SUBJECT',
                                                                                                        'ISR EXEMPT'
                                                                                                     )
                                                                )
                                                            OR  (    
                                                                    UPPER (pec.base_classification_name) IN (  
                                                                                                                'ABSENCES',
                                                                                                                'VOLUNTARY DEDUCTIONS',
                                                                                                                'INVOLUNTARY DEDUCTIONS'
                                                                                                            )
                                                                    AND UPPER (TRIM (pivtl.name)) IN (  
                                                                                                        'PAY VALUE',
                                                                                                        'VALOR PAGO',
                                                                                                        'NET PAY',
                                                                                                        'ISR SUBJECT',
                                                                                                        'ISR EXEMPT'
                                                                                                     )
                                                                )
                                                            )
                                                        OR  (    
                                                                UPPER (pec.base_classification_name) = 'INFORMATION'
                                                                AND UPPER (TRIM (pivtl.name)) IN (  
                                                                                                    'PAY VALUE',
                                                                                                    'VALOR PAGO',
                                                                                                    'EARNINGS AMOUNT',
                                                                                                    'DIAS',
                                                                                                    'HORAS',
                                                                                                    'ISR SUBJECT',
                                                                                                    'ISR EXEMPT'
                                                                                                 )
                                                            )
                                                        OR  (    
                                                                UPPER (pec.base_classification_name) = 'GLB_SEVERANCE_PAY'
                                                                AND UPPER (TRIM (pivtl.name)) IN (  
                                                                                                    'EARNINGS CALCULATED',
                                                                                                    'ISR SUBJECT',
                                                                                                    'ISR EXEMPT'
                                                                                                 )
                                                            )
                                                    )
                                                AND TRUNC (SYSDATE)         BETWEEN pet.effective_start_date AND pet.effective_end_date
                                                AND TRUNC (SYSDATE)         BETWEEN piv.effective_start_date AND piv.effective_end_date
                                                AND pettl.language          = SYS_CONTEXT ('USERENV', 'LANG')
                                                AND pivtl.language          = SYS_CONTEXT ('USERENV', 'LANG')
                                        GROUP BY    UPPER (TRIM (pec.base_classification_name)),
                                                    UPPER(TRIM(pivtl.name)),
                                                    prtf.shortname,
                                                    ppra.payroll_rel_action_id                                               
                                    )
                        )
                GROUP BY  payroll_rel_action_id
            )
),                   
total_deduccion AS (
SELECT  importe total_deduc,
        payroll_rel_action_id
FROM    (
            SELECT  SUM(importe) importe,
                    payroll_rel_action_id
            FROM    (
                        SELECT  CASE
                                    WHEN input_name <> 'ISR EXEMPT' AND input_name <> 'ISR SUBJECT' THEN
                                        result_value
                                    ELSE
                                        0
                                END importe,
                                payroll_rel_action_id
                        FROM    (            
                                    SELECT  UPPER(TRIM(pivtl.name)) input_name,
                                            CASE 
                                                WHEN UPPER (TRIM (pec.base_classification_name)) = 'SOCIAL INSURANCE DEDUCTIONS' AND UPPER(TRIM(pivtl.name)) = 'SDI' AND prtf.shortname <> 'REGNOR' THEN
                                                    0
                                                ELSE        
                                                    ABS(SUM(prrv.result_value))
                                            END AS result_value,
                                            ppra.payroll_rel_action_id                              
                                    FROM    pay_payroll_rel_actions         ppra,
                                            pay_run_types_f                 prtf,
                                            pay_run_results                 prr,
                                            pay_run_result_values           prrv,
                                            pay_element_types_f             pet,
                                            pay_element_types_tl            pettl,
                                            fusion.pay_ele_classifications  pec,
                                            fusion.pay_input_values_f       piv,
                                            pay_input_values_tl             pivtl,
                                            cat_elements_ded                elem
                                    WHERE   1 = 1
                                            AND ppra.run_type_id            = prtf.run_type_id
                                            AND ppra.payroll_rel_action_id  = prr.payroll_rel_action_id
                                            AND prr.run_result_id           = prrv.run_result_id
                                            AND prr.status                  IN ('P', 'PA')
                                            AND prr.element_type_id         = pet.element_type_id
                                            AND pet.element_type_id         = pettl.element_type_id
                                            AND pet.classification_id       = pec.classification_id
                                            AND pet.element_type_id         = piv.element_type_id
                                            AND prrv.input_value_id         = piv.input_value_id
                                            AND piv.input_value_id          = pivtl.input_value_id
                                            AND piv.user_display_flag       = 'Y'
                                            AND UPPER(pettl.element_name)   = UPPER(elem.element_name)
                                            AND (    
                                                    (     
                                                        UPPER (pec.base_classification_name) IN (   
                                                                                                    'STANDARD EARNINGS',
                                                                                                    'SUPPLEMENTAL EARNINGS',
                                                                                                    'TAXABLE BENEFITS'
                                                                                                )
                                                        AND UPPER (TRIM (pivtl.name)) IN (  
                                                                                            'PAY VALUE',
                                                                                            'VALOR PAGO',
                                                                                            'EARNINGS CALCULATED',
                                                                                            'ISR SUBJECT',
                                                                                            'ISR EXEMPT'
                                                                                         )
                                                    )
                                                    OR  (   
                                                            (    
                                                                UPPER (pec.base_classification_name) IN (  
                                                                                                            'TAX DEDUCTIONS',
                                                                                                            'SOCIAL INSURANCE DEDUCTIONS',
                                                                                                            'EMPLOYER TAXES'
                                                                                                        )
                                                                AND UPPER (TRIM (pivtl.name)) IN (  
                                                                                                    'EMPLOYER SOCIAL SECURITY QUOTA',
                                                                                                    'SDI',
                                                                                                    'PAY VALUE',
                                                                                                    'VALOR PAGO',
                                                                                                    'ISR WITHHELD',
                                                                                                    'ISR SUBSIDY FOR EMPLOYMENT PAID',
                                                                                                    'ISR SUBJECT',
                                                                                                    'ISR EXEMPT'
                                                                                                 )
                                                            )
                                                        OR  (    
                                                                UPPER (pec.base_classification_name) IN (  
                                                                                                            'ABSENCES',
                                                                                                            'VOLUNTARY DEDUCTIONS',
                                                                                                            'INVOLUNTARY DEDUCTIONS'
                                                                                                        )
                                                                AND UPPER (TRIM (pivtl.name)) IN (  
                                                                                                    'PAY VALUE',
                                                                                                    'VALOR PAGO',
                                                                                                    'NET PAY',
                                                                                                    'ISR SUBJECT',
                                                                                                    'ISR EXEMPT'
                                                                                                 )
                                                            )
                                                        )
                                                    OR  (    
                                                            UPPER (pec.base_classification_name) = 'INFORMATION'
                                                            AND UPPER (TRIM (pivtl.name)) IN (  
                                                                                                'PAY VALUE',
                                                                                                'VALOR PAGO',
                                                                                                'EARNINGS AMOUNT',
                                                                                                'DIAS',
                                                                                                'HORAS',
                                                                                                'ISR SUBJECT',
                                                                                                'ISR EXEMPT'
                                                                                             )
                                                        )
                                                    OR  (    
                                                            UPPER (pec.base_classification_name) = 'GLB_SEVERANCE_PAY'
                                                            AND UPPER (TRIM (pivtl.name)) IN (  
                                                                                                'EARNINGS CALCULATED',
                                                                                                'ISR SUBJECT',
                                                                                                'ISR EXEMPT'
                                                                                             )
                                                        )
                                                )
                                            AND TRUNC (SYSDATE)             BETWEEN pet.effective_start_date AND pet.effective_end_date
                                            AND TRUNC (SYSDATE)             BETWEEN piv.effective_start_date AND piv.effective_end_date
                                            AND pettl.language              = SYS_CONTEXT ('USERENV', 'LANG')
                                            AND pivtl.language              = SYS_CONTEXT ('USERENV', 'LANG')
                                    GROUP BY    UPPER (TRIM (pec.base_classification_name)),
                                                UPPER(TRIM(pivtl.name)),
                                                prtf.shortname,
                                                ppra.payroll_rel_action_id                                               
                                )
                    )
            GROUP BY  payroll_rel_action_id
        )
),
total_dif_caja_ahorro as (
    SELECT  abs(nvl (importe, 0)) * -1 monto_dif_caja,
            payroll_rel_action_id
    FROM    (
                SELECT  SUM(importe) importe,
                        payroll_rel_action_id
                FROM    (
                            SELECT  CASE
                                        WHEN input_name <> 'ISR EXEMPT' AND input_name <> 'ISR SUBJECT' THEN
                                            result_value
                                        ELSE
                                            0
                                    END importe,
                                    payroll_rel_action_id
                            FROM    (            
                                        SELECT  UPPER(TRIM(pivtl.name)) input_name,
                                                CASE 
                                                    WHEN UPPER (TRIM (pec.base_classification_name)) = 'SOCIAL INSURANCE DEDUCTIONS' AND UPPER(TRIM(pivtl.name)) = 'SDI' AND prtf.shortname <> 'REGNOR' THEN
                                                        0
                                                    ELSE        
                                                        SUM(prrv.result_value)
                                                END AS result_value,
                                                ppra.payroll_rel_action_id                                  
                                        FROM    pay_payroll_rel_actions         ppra,
                                                pay_run_types_f                 prtf,
                                                pay_run_results                 prr,
                                                pay_run_result_values           prrv,
                                                pay_element_types_f             pet,
                                                pay_element_types_tl            pettl,
                                                fusion.pay_ele_classifications  pec,
                                                fusion.pay_input_values_f       piv,
                                                pay_input_values_tl             pivtl,
                                                cat_diferencia_fondo_ahorro     elem
                                        WHERE   1 = 1
                                                AND ppra.run_type_id            = prtf.run_type_id
                                                AND ppra.payroll_rel_action_id  = prr.payroll_rel_action_id
                                                AND prr.run_result_id           = prrv.run_result_id
                                                AND prr.status                  IN ('P', 'PA')
                                                AND prr.element_type_id         = pet.element_type_id
                                                AND pet.element_type_id         = pettl.element_type_id
                                                AND pet.classification_id       = pec.classification_id
                                                AND pet.element_type_id         = piv.element_type_id
                                                AND prrv.input_value_id         = piv.input_value_id
                                                AND piv.input_value_id          = pivtl.input_value_id
                                                AND piv.user_display_flag       = 'Y'
                                                AND UPPER(pettl.element_name)   = UPPER(elem.element_name)
                                                AND (    
                                                        (     
                                                            UPPER (pec.base_classification_name) IN (   
                                                                                                        'STANDARD EARNINGS',
                                                                                                        'SUPPLEMENTAL EARNINGS',
                                                                                                        'TAXABLE BENEFITS'
                                                                                                    )
                                                            AND UPPER (TRIM (pivtl.name)) IN (  
                                                                                                'PAY VALUE',
                                                                                                'VALOR PAGO',
                                                                                                'EARNINGS CALCULATED',
                                                                                                'ISR SUBJECT',
                                                                                                'ISR EXEMPT'
                                                                                             )
                                                        )
                                                        OR  (   
                                                                (    
                                                                    UPPER (pec.base_classification_name) IN (  
                                                                                                                'TAX DEDUCTIONS',
                                                                                                                'SOCIAL INSURANCE DEDUCTIONS',
                                                                                                                'EMPLOYER TAXES'
                                                                                                            )
                                                                    AND UPPER (TRIM (pivtl.name)) IN (  
                                                                                                        'EMPLOYER SOCIAL SECURITY QUOTA',
                                                                                                        'SDI',
                                                                                                        'PAY VALUE',
                                                                                                        'VALOR PAGO',
                                                                                                        'ISR WITHHELD',
                                                                                                        'ISR SUBSIDY FOR EMPLOYMENT PAID',
                                                                                                        'ISR SUBJECT',
                                                                                                        'ISR EXEMPT'
                                                                                                     )
                                                                )
                                                            OR  (    
                                                                    UPPER (pec.base_classification_name) IN (  
                                                                                                                'ABSENCES',
                                                                                                                'VOLUNTARY DEDUCTIONS',
                                                                                                                'INVOLUNTARY DEDUCTIONS'
                                                                                                            )
                                                                    AND UPPER (TRIM (pivtl.name)) IN (  
                                                                                                        'PAY VALUE',
                                                                                                        'VALOR PAGO',
                                                                                                        'NET PAY',
                                                                                                        'ISR SUBJECT',
                                                                                                        'ISR EXEMPT'
                                                                                                     )
                                                                )
                                                            )
                                                        OR  (    
                                                                UPPER (pec.base_classification_name) = 'INFORMATION'
                                                                AND UPPER (TRIM (pivtl.name)) IN (  
                                                                                                    'PAY VALUE',
                                                                                                    'VALOR PAGO',
                                                                                                    'EARNINGS AMOUNT',
                                                                                                    'DIAS',
                                                                                                    'HORAS',
                                                                                                    'ISR SUBJECT',
                                                                                                    'ISR EXEMPT'
                                                                                                 )
                                                            )
                                                        OR  (    
                                                                UPPER (pec.base_classification_name) = 'GLB_SEVERANCE_PAY'
                                                                AND UPPER (TRIM (pivtl.name)) IN (  
                                                                                                    'EARNINGS CALCULATED',
                                                                                                    'ISR SUBJECT',
                                                                                                    'ISR EXEMPT'
                                                                                                 )
                                                            )
                                                    )
                                                AND TRUNC (SYSDATE)             BETWEEN pet.effective_start_date AND pet.effective_end_date
                                                AND TRUNC (SYSDATE)             BETWEEN piv.effective_start_date AND piv.effective_end_date
                                                AND pettl.language              = SYS_CONTEXT ('USERENV', 'LANG')
                                                AND pivtl.language              = SYS_CONTEXT ('USERENV', 'LANG')
                                        GROUP BY    UPPER (TRIM (pec.base_classification_name)),
                                                    UPPER(TRIM(pivtl.name)),
                                                    prtf.shortname,
                                                    UPPER(TRIM(pivtl.name)),
                                                    ppra.payroll_rel_action_id                                                 
                                    )
                        )
                GROUP BY payroll_rel_action_id
            )
)
SELECT  FLUJO,
        FLOW_INSTANCE_ID,
        NUMERO_CHEQUE,
        PERSON_ID,
        NOMBRE,
        ESTAFETA,
        ESTATUS,
        CANTIDAD
FROM    (
            SELECT  REPLACE(UPPER ((ppn.last_name ||' '||ppn.previous_last_name||' '||ppn.first_name||' '||ppn.middle_names)),'  ',' ') AS nombre,
                    pap.person_number estafeta,
                    pap.person_id,
                    upper(xler.registered_name) empresa,
                    xler.registration_number rfc_empresa,
                    ppa.assignment_set_id AS flow_instance_id,
                    base_object_group_name AS flujo,
                    '-' AS numero_cheque,
                    'PA' AS estatus,
                    (
                        SELECT  NVL(SUM(total),0) monto_finiquito_total
                        FROM    (
                                    SELECT  (nvl(sum(total),0) + nvl(total_indem,0)) - nvl(total_deduc,0) + (nvl(total_dif_caja_ahorro,0)) total, --+ nvl(total_dif_caja_ahorro,0)) total,
                                            payroll_rel_action_id
                                    FROM    (
                                                SELECT  CASE
                                                            WHEN input_name <> 'ISR EXEMPT' AND input_name <> 'ISR SUBJECT' THEN
                                                                result_value
                                                            ELSE
                                                                0
                                                        END total,
                                                        payroll_rel_action_id,
                                                        total_deduc,
                                                        total_indem,
                                                        total_dif_caja_ahorro
                                                FROM    (            
                                                            SELECT  UPPER(TRIM(pivtl.name)) input_name,
                                                                    CASE 
                                                                        WHEN UPPER (TRIM (pec.base_classification_name)) = 'SOCIAL INSURANCE DEDUCTIONS' 
                                                                        AND UPPER(TRIM(pivtl.name)) = 'SDI' AND prtf.shortname <> 'REGNOR' THEN
                                                                            0
                                                                        ELSE        
                                                                            SUM(prrv.result_value)
                                                                    END  AS result_value,
                                                                    ppra.payroll_rel_action_id,
                                                                    (   
                                                                        select  td.total_deduc 
                                                                        from    total_deduccion td
                                                                        where   ppra.payroll_rel_action_id = td.payroll_rel_action_id
                                                                    ) total_deduc,
                                                                    (
                                                                        select  tp.total_indem 
                                                                        from    total_indem tp
                                                                        where   ppra.payroll_rel_action_id = tp.payroll_rel_action_id
                                                                    ) total_indem,
                                                                    (
                                                                        select  tda.monto_dif_caja 
                                                                        from    total_dif_caja_ahorro tda
                                                                        where   ppra.payroll_rel_action_id = tda.payroll_rel_action_id
                                                                    ) total_dif_caja_ahorro
                                                            FROM    pay_payroll_rel_actions         ppra,
                                                                    pay_run_types_f                 prtf,
                                                                    pay_run_results                 prr,
                                                                    pay_run_result_values           prrv,
                                                                    pay_element_types_f             pet,
                                                                    pay_element_types_tl            pettl,
                                                                    fusion.pay_ele_classifications  pec,
                                                                    fusion.pay_input_values_f       piv,
                                                                    pay_input_values_tl             pivtl,
                                                                    cat_element_percep              elem
                                                            WHERE   1 = 1
                                                                    AND ppra.run_type_id = prtf.run_type_id
                                                                    AND ppra.payroll_rel_action_id = prr.payroll_rel_action_id
                                                                    AND prr.run_result_id = prrv.run_result_id
                                                                    AND prr.status IN ('P', 'PA')
                                                                    AND prr.element_type_id = pet.element_type_id
                                                                    AND pet.element_type_id = pettl.element_type_id
                                                                    AND pet.classification_id = pec.classification_id
                                                                    AND pet.element_type_id = piv.element_type_id
                                                                    AND prrv.input_value_id = piv.input_value_id
                                                                    AND piv.input_value_id = pivtl.input_value_id
                                                                    AND piv.user_display_flag = 'Y'
                                                                    AND UPPER(pettl.element_name) = UPPER(elem.element_name)
                                                                    AND (    
                                                                            (     
                                                                                UPPER (pec.base_classification_name) IN (  
                                                                                                                            'STANDARD EARNINGS',
                                                                                                                            'SUPPLEMENTAL EARNINGS',
                                                                                                                            'TAXABLE BENEFITS'
                                                                                                                        )
                                                                                AND UPPER (TRIM (pivtl.name)) IN (  
                                                                                                                    'PAY VALUE',
                                                                                                                    'VALOR PAGO',
                                                                                                                    'EARNINGS CALCULATED',
                                                                                                                    'ISR SUBJECT',
                                                                                                                    'ISR EXEMPT'
                                                                                                                )
                                                                            )
                                                                            OR  (   
                                                                                    (    
                                                                                        UPPER (pec.base_classification_name) IN (  'TAX DEDUCTIONS'
                                                                                                                                , 'SOCIAL INSURANCE DEDUCTIONS'
                                                                                                                                , 'EMPLOYER TAXES'
                                                                                                                                )
                                                                                        AND UPPER (TRIM (pivtl.name)) IN (  
                                                                                                                            'EMPLOYER SOCIAL SECURITY QUOTA',
                                                                                                                            'SDI',
                                                                                                                            'PAY VALUE',
                                                                                                                            'VALOR PAGO',
                                                                                                                            'ISR WITHHELD',
                                                                                                                            'ISR SUBSIDY FOR EMPLOYMENT PAID',
                                                                                                                            'ISR SUBJECT',
                                                                                                                            'ISR EXEMPT'
                                                                                                                        )
                                                                                    )
                                                                                OR  (    
                                                                                        UPPER (pec.base_classification_name) IN (  
                                                                                                                                    'ABSENCES',
                                                                                                                                    'VOLUNTARY DEDUCTIONS',
                                                                                                                                    'INVOLUNTARY DEDUCTIONS'
                                                                                                                                )
                                                                                        AND UPPER (TRIM (pivtl.name)) IN (  
                                                                                                                            'PAY VALUE',
                                                                                                                            'VALOR PAGO',
                                                                                                                            'NET PAY',
                                                                                                                            'ISR SUBJECT',
                                                                                                                            'ISR EXEMPT'
                                                                                                                        )
                                                                                    )
                                                                                )
                                                                            OR  (    
                                                                                    UPPER (pec.base_classification_name) = 'INFORMATION'
                                                                                    AND UPPER (TRIM (pivtl.name)) IN (  
                                                                                                                        'PAY VALUE',
                                                                                                                        'VALOR PAGO',
                                                                                                                        'EARNINGS AMOUNT',
                                                                                                                        'DIAS',
                                                                                                                        'HORAS',
                                                                                                                        'ISR SUBJECT',
                                                                                                                        'ISR EXEMPT'
                                                                                                                    )
                                                                                )
                                                                            OR  (    
                                                                                    UPPER (pec.base_classification_name) = 'GLB_SEVERANCE_PAY'
                                                                                    AND UPPER (TRIM (pivtl.name)) IN (  
                                                                                                                        'EARNINGS CALCULATED',
                                                                                                                        'ISR SUBJECT',
                                                                                                                        'ISR EXEMPT'
                                                                                                                    )
                                                                                )
                                                                        )
                                                                    AND TRUNC (SYSDATE)             BETWEEN pet.effective_start_date AND pet.effective_end_date
                                                                    AND TRUNC (SYSDATE)             BETWEEN piv.effective_start_date AND piv.effective_end_date
                                                                    AND pettl.language              = SYS_CONTEXT ('USERENV', 'LANG')
                                                                    AND pivtl.language              = SYS_CONTEXT ('USERENV', 'LANG')
                                                            GROUP BY    UPPER (TRIM (pec.base_classification_name)),
                                                                        UPPER(TRIM(pivtl.name)),
                                                                        prtf.shortname,
                                                                        ppra.payroll_rel_action_id
                                                        )
                                            )
                                    GROUP BY  payroll_rel_action_id
                                                , total_deduc
                                                ,total_indem
                                                ,total_dif_caja_ahorro
                                )
                        WHERE payroll_rel_action_id = ppra.payroll_rel_action_id
                        GROUP BY    payroll_rel_action_id
                    ) cantidad
            FROM      pay_payroll_actions             ppa
                    , pay_payroll_rel_actions         ppra
                    , pay_run_types_f                 prtf
                    , pay_consolidation_sets          pcs
                    , pay_rel_groups_dn               prg
                    , per_all_assignments_f           paa
                    , per_all_people_f                pap
                    , per_person_names_f              ppn
                    , per_periods_of_service          ppos
                    , per_jobs_f_tl                   pj
                    , hr_organization_information_f   hoi_unidad
                    , hr_all_organization_units       haou_unidad
                    , hr_lookups                      hl_categoria
                    , pay_time_periods                ptp
                    , hr_locations_all                hla
                    , per_legal_employers             ple
                    , xle_entity_profiles             xlep
                    , xle_registrations               xler
                    , hz_locations                    hl_le
                    , hr_organization_information_f   hoi_le
                    , hcm_lookups                     hl
                    , per_location_details_f_tl       pldft
                    , per_location_details_f          pldf
                    , per_locations                   pl
                    , hr_organization_units_f_tl      hou
                    , pay_object_groups               pog
            WHERE     1 = 1
                    AND ppa.payroll_action_id                               = ppra.payroll_action_id
                    --AND ppra.payroll_rel_action_id                          IN (736687104,533940648)
                    --AND ppa.action_status = 'C'
                    AND ppa.action_type                                     IN ('R', 'Q', 'B')
                    AND ppra.action_status                                  = 'C' --
                    AND ppra.run_type_id                                    = prtf.run_type_id
                    AND ppa.consolidation_set_id                            = pcs.consolidation_set_id
                    AND ppra.payroll_relationship_id                        = prg.payroll_relationship_id
                    AND ppra.retro_component_id                             IS NULL
                    AND prg.assignment_id                                   = paa.assignment_id
                    AND paa.assignment_type                                 = 'E'
                    AND paa.effective_latest_change                         = 'Y'
                    AND paa.person_id                                       = pap.person_id
                    AND pap.person_id                                       = ppn.person_id
                    AND pap.person_number                                   = NVL(:estafeta,pap.person_number)
                    AND ppa.ASSIGNMENT_SET_ID                            = NVL(:FLUJO,ppa.ASSIGNMENT_SET_ID)
                    AND ppn.name_type                                       = 'MX'
                    AND pap.person_id                                       = ppos.person_id
                    AND paa.period_of_service_id                            = ppos.period_of_service_id
                    AND paa.legal_entity_id                                 = ppos.legal_entity_id
                    AND paa.job_id                                          = pj.job_id
                    AND pj.language                                         = SYS_CONTEXT ('USERENV', 'LANG')
                    AND paa.organization_id                                 = hoi_unidad.organization_id(+)
                    AND hoi_unidad.org_information_context(+)               = 'PER_GL_COST_CENTER_INFO'
                    AND hoi_unidad.org_information7(+)                      = '1'
                    AND paa.organization_id                                 = haou_unidad.organization_id
                    AND paa.employee_category                               = hl_categoria.lookup_code
                    AND hl_categoria.lookup_type                            = 'EMPLOYEE_CATG'
                    AND ppa.effective_date                                  BETWEEN prg.start_date AND prg.end_date
                    AND ppa.earn_time_period_id                             = ptp.time_period_id
                    AND paa.location_id                                     = hla.location_id
                    AND paa.legal_entity_id                                 = ple.organization_id
                    AND ple.legal_entity_id                                 = xlep.legal_entity_id
                    AND xlep.legal_entity_id                                = xler.source_id
                    AND xler.source_table                                   = 'XLE_ENTITY_PROFILES'
                    AND xler.location_id                                    = hl_le.location_id
                    AND ple.organization_id                                 = hoi_le.organization_id(+)
                    AND hoi_le.org_information_context(+)                   = 'ORA_HRX_MX_SOCIAL_SECURITY_DETAILS'
                    AND hoi_le.org_information1                             = hl.lookup_code(+)
                    AND hl.lookup_type(+)                                   = 'ORA_HRX_MX_WORK_RISK_CLASS'
                    AND pldft.location_details_id                           = pldf.location_details_id --
                    AND pldft.language                                      = 'E' --
                    AND pl.location_id                                      = paa.location_id --
                    AND pldf.location_id                                    = pl.location_id --
                    --+ ubicacion
                    AND pl.location_id = hla.location_id 
                    ----+
                    AND paa.business_unit_id    = hou.organization_id(+) 
                    AND hou.language(+)         = SYS_CONTEXT('USERENV', 'LANG')
                    AND TRUNC (ppa.date_earned) BETWEEN hou.effective_start_date(+) AND hou.effective_end_date(+)
                    --+
                    AND ppa.assignment_set_id   = pog.object_group_id
                    --+
                    AND TRUNC (ppa.date_earned)                                     BETWEEN TRUNC(paa.effective_start_date) 
                                                                                    AND TRUNC(paa.effective_end_date)
                    AND TRUNC (ppa.date_earned)                                     BETWEEN TRUNC(pap.effective_start_date) 
                                                                                    AND TRUNC(pap.effective_end_date)
                    AND TRUNC (ppa.date_earned)                                     BETWEEN TRUNC(ppn.effective_start_date) 
                                                                                    AND TRUNC(ppn.effective_end_date)
                    AND TRUNC (ppa.date_earned)                                     BETWEEN TRUNC(pj.effective_start_date)  
                                                                                    AND TRUNC(pj.effective_end_date)
                    AND TRUNC (ppa.date_earned)                                     BETWEEN TRUNC(hoi_unidad.effective_start_date) 
                                                                                    AND TRUNC(hoi_unidad.effective_end_date)
                    AND TRUNC (ppa.date_earned)                                     BETWEEN TRUNC(hoi_le.effective_start_date(+)) 
                                                                                    AND TRUNC(hoi_le.effective_end_date(+))
                    AND TRUNC (ppa.date_earned)                                     BETWEEN pldf.effective_start_date 
                                                                                    AND pldf.effective_end_date
        )
WHERE   cantidad = 0
GROUP BY    FLUJO,
            FLOW_INSTANCE_ID,
            NUMERO_CHEQUE,
            PERSON_ID,
            NOMBRE,
            ESTAFETA,
            ESTATUS,
            CANTIDAD
