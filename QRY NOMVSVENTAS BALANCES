--QRY NOMVSVENTAS BALANCES
WITH      xx_cuentas AS(
                        SELECT    REGEXP_SUBSTR (:p_cuentas, '[^|]+', 1, level) segment4
                        FROM      dual
                        CONNECT BY LEVEL <= LENGTH (REGEXP_REPLACE (:p_cuentas, '[^|]+')) + 1
                       )
SELECT    monto_anterior
        , monto_actual
        , monto_presupuesto_anterior
        , monto_presupuesto
        , segment3
        , period_num
FROM      (
            SELECT    SUM(monto_anterior) monto_anterior
                    , SUM(monto_actual) monto_actual
                    , SUM(monto_presupuesto_anterior) monto_presupuesto_anterior
                    , SUM(monto_presupuesto) monto_presupuesto
                    , segment3
                    , period_num
            FROM      (
                        SELECT    CASE
                                    WHEN period_year = :p_anio_anterior AND actual_flag = 'A' THEN
                                        SUM(montos)
                                    ELSE
                                        0
                                  END monto_anterior
                                , CASE
                                    WHEN period_year = :p_anio_actual AND actual_flag = 'A' THEN
                                        SUM(montos)
                                    ELSE
                                        0
                                  END monto_actual
                                , CASE
                                    WHEN period_year = :p_anio_anterior AND actual_flag = 'B' THEN
                                        SUM(montos)
                                    ELSE
                                        0
                                  END monto_presupuesto_anterior
                                , CASE
                                    WHEN period_year = :p_anio_actual AND actual_flag = 'B' THEN
                                        SUM(montos)
                                    ELSE
                                        0
                                  END monto_presupuesto
                                , segment3
                                , period_num
                        FROM      (
                                    SELECT    CASE
                                                WHEN :p_tipo_balance = 'VENTAS' THEN
                                                    SUM(NVL(gjl.entered_cr, 0) - NVL(gjl.entered_dr, 0))
                                                ELSE
                                                    SUM(NVL(gjl.entered_dr, 0) - NVL(gjl.entered_cr, 0))
                                              END montos
                                            , gcc.segment3
                                            , gp.period_num
                                            , gp.period_year
                                            , 'A' actual_flag
                                    FROM      gl_je_headers gjh
                                            , gl_je_lines gjl
                                            , gl_code_combinations gcc
                                            , gl_je_categories gjct
                                            , gl_period_statuses gp
                                            , gl_ledgers gl
                                    WHERE     1 = 1
                                    AND       (   (     :p_tipo_balance <> 'VENTAS'
                                                    AND gjct.je_category_key IN ('1', 'Payroll')
                                                  )
                                               OR (     :p_tipo_balance <> 'VENTAS'
                                                   AND gjct.je_category_key = gjct.je_category_key
                                                   AND gp.period_year = 2020
                                                  )
                                               OR (
                                                        :p_tipo_balance = 'VENTAS'
                                                    AND gjct.je_category_key = gjct.je_category_key
                                                  )
                                              )
                                    AND       gjh.je_header_id = gjl.je_header_id
                                    AND       gjl.code_combination_id = gcc.code_combination_id
                                    AND       gjh.je_category = gjct.je_category_name
                                    AND       gjh.period_name = gp.period_name
                                    AND       gp.application_id = 101
                                    AND       gjh.ledger_id = gl.ledger_id
                                    AND       gl.ledger_category_code = 'PRIMARY'
                                    AND       gp.ledger_id = gl.ledger_id
                                    AND       gjh.actual_flag IN ('A')
                                    AND       gjh.status = 'P'
                                    AND       gjh.currency_code = 'MXN'
                                    AND       gp.period_num BETWEEN DECODE (  :p_acumulado
                                                                            , 'Y'
                                                                            , 1
                                                                            , :p_period_num
                                                                           ) AND :p_period_num
                                    AND       gp.period_year IN (:p_anio_anterior, :p_anio_actual)
                                    --
                                    AND       (
                                                    (    :p_tipo_balance IN ('STAFF DIRECTO', 'STAFF INDIRECTO')
                                                     AND gcc.segment1 IN (
                                                                            SELECT    ffvv.flex_value   segment1
                                                                            FROM      fun_all_business_units_v fabu
                                                                                    , hr_legal_entities        hle
                                                                                    , gl_ledgers               gl
                                                                                    , fnd_flex_values_vl       ffvv
                                                                                    , fnd_id_flex_segments_vl  fifsv
                                                                                    , gl_ledger_segment_values glsv
                                                                            WHERE     1 = 1
                                                                            AND       fabu.status = 'A'
                                                                            AND       fabu.legal_entity_id = hle.legal_entity_id
                                                                            AND       hle.classification_code = 'HCM_LEMP'
                                                                            AND       hle.status = 'A'
                                                                            AND       hle.organization_id = :p_organization_id 
                                                                            AND       fabu.primary_ledger_id = gl.ledger_id
                                                                            AND       gl.chart_of_accounts_id = fifsv.id_flex_num
                                                                            AND       fifsv.id_flex_code = 'GL#'
                                                                            AND       fifsv.enabled_flag = 'Y'
                                                                            AND       UPPER(fifsv.application_column_name) = 'SEGMENT1'
                                                                            AND       fifsv.flex_value_set_id = ffvv.flex_value_set_id
                                                                            AND       ffvv.enabled_flag = 'Y'
                                                                            AND       ffvv.flex_value = glsv.segment_value
                                                                            AND       fabu.legal_entity_id = glsv.legal_entity_id
                                                                            AND       gl.ledger_id = glsv.ledger_id 
                                                                            AND       TRUNC(SYSDATE) BETWEEN hle.effective_start_date AND hle.effective_end_date
                                                                            AND       EXISTS (
                                                                                                SELECT    NULL
                                                                                                FROM      (
                                                                                                            SELECT    emp_ven.empresa
                                                                                                                    , emp_ven.empresa_nomina 
                                                                                                                    , regexp_substr(emp_ven.empresa_venta, '[^~]+', 1, level) empresa_venta
                                                                                                            FROM      (
                                                                                                                        SELECT    emp_nom.empresa
                                                                                                                                , regexp_substr(emp_nom.empresa_nomina, '[^~]+', 1, level) empresa_nomina
                                                                                                                                , emp_nom.empresa_venta
                                                                                                                        FROM      (
                                                                                                                                    SELECT    flv.meaning empresa
                                                                                                                                            , flv.description empresa_nomina
                                                                                                                                            , flv.tag||'~' empresa_venta
                                                                                                                                    FROM      fnd_lookup_values flv
                                                                                                                                    WHERE     flv.lookup_type = 'XXTOKS_PLANTILLA_VS_VENTA'
                                                                                                                                    AND       flv.language = USERENV('LANG')
                                                                                                                                    AND       flv.meaning = fabu.bu_name 
                                                                                                                                  ) emp_nom
                                                                                                                        CONNECT BY level <= LENGTH(regexp_replace(emp_nom.empresa_nomina, '[^~]+')) + 1
                                                                                                                      ) emp_ven
                                                                                                            CONNECT BY level <= LENGTH(regexp_replace(emp_ven.empresa_venta, '[^~]+')) + 1
                                                                                                          ) venta_nomina
                                                                                                WHERE     1 = 1
                                                                                                AND       venta_nomina.empresa_venta IS NOT NULL
                                                                                                AND       venta_nomina.empresa_nomina = fabu.bu_name 
                                                                                              )
                                                                          )
                                                    )
                                                 OR (    :p_tipo_balance = 'VENTAS'
                                                     AND gcc.segment1 IN (
                                                                            SELECT    ffvv.flex_value   segment1
                                                                            FROM      fun_all_business_units_v fabu
                                                                                    , gl_ledgers               gl
                                                                                    , fnd_flex_values_vl       ffvv
                                                                                    , fnd_id_flex_segments_vl  fifsv
                                                                                    , gl_ledger_segment_values glsv
                                                                            WHERE     1 = 1
                                                                            AND       fabu.status = 'A'
                                                                            AND       fabu.primary_ledger_id = gl.ledger_id
                                                                            AND       gl.chart_of_accounts_id = fifsv.id_flex_num
                                                                            AND       fifsv.id_flex_code = 'GL#'
                                                                            AND       fifsv.enabled_flag = 'Y'
                                                                            AND       UPPER(fifsv.application_column_name) = 'SEGMENT1'
                                                                            AND       fifsv.flex_value_set_id = ffvv.flex_value_set_id
                                                                            AND       ffvv.enabled_flag = 'Y'
                                                                            AND       ffvv.flex_value = glsv.segment_value
                                                                            AND       fabu.legal_entity_id = glsv.legal_entity_id
                                                                            AND       gl.ledger_id = glsv.ledger_id 
                                                                            AND EXISTS (
                                                                                        SELECT    NULL
                                                                                        FROM      (
                                                                                                    SELECT    emp_ven.empresa
                                                                                                            , emp_ven.empresa_nomina 
                                                                                                            , regexp_substr(emp_ven.empresa_venta, '[^~]+', 1, level) empresa_venta
                                                                                                    FROM      (
                                                                                                                SELECT    emp_nom.empresa
                                                                                                                        , regexp_substr(emp_nom.empresa_nomina, '[^~]+', 1, level) empresa_nomina
                                                                                                                        , emp_nom.empresa_venta
                                                                                                                FROM      (
                                                                                                                            SELECT    flv.meaning empresa
                                                                                                                                    , flv.description empresa_nomina
                                                                                                                                    , flv.tag||'~' empresa_venta
                                                                                                                            FROM      fnd_lookup_values flv
                                                                                                                            WHERE     1 = 1
                                                                                                                            AND       flv.lookup_type = 'XXTOKS_PLANTILLA_VS_VENTA'
                                                                                                                            AND       flv.language = USERENV('LANG')
                                                                                                                            AND       flv.meaning  IN (
                                                                                                                                                        SELECT    fabu2.bu_name
                                                                                                                                                        FROM      hr_legal_entities hle
                                                                                                                                                                , fun_all_business_units_v fabu2
                                                                                                                                                                , gl_ledgers gl
                                                                                                                                                        WHERE     1 = 1
                                                                                                                                                        AND       hle.organization_id = :p_organization_id
                                                                                                                                                        AND       hle.classification_code = 'HCM_LEMP'
                                                                                                                                                        AND       hle.status = 'A'
                                                                                                                                                        AND       hle.legal_entity_id = fabu2.legal_entity_id 
                                                                                                                                                        AND       fabu2.status = 'A'
                                                                                                                                                        AND       fabu2.profit_center_flag = 'Y'
                                                                                                                                                        AND       gl.ledger_id = fabu2.primary_ledger_id 
                                                                                                                                                        AND       TRUNC (SYSDATE) BETWEEN hle.effective_start_date AND hle.effective_end_date
                                                                                                                                                      )
                                                                                                                          ) emp_nom
                                                                                                                CONNECT BY level <= LENGTH(regexp_replace(emp_nom.empresa_nomina, '[^~]+')) + 1
                                                                                                              ) emp_ven
                                                                                                    CONNECT BY level <= LENGTH(regexp_replace(emp_ven.empresa_venta, '[^~]+')) + 1
                                                                                                  ) venta_nomina
                                                                                        WHERE     1 = 1
                                                                                        AND       venta_nomina.empresa_venta IS NOT NULL
                                                                                        AND       venta_nomina.empresa_venta = fabu.bu_name 
                                                                                       )
                                                                         )
                                                    )
                                              )
                                    --
                                    AND       (   gcc.segment3 = NVL(:p_unidad, gcc.segment3)
                                               OR gcc.segment3 IN (
                                                                    SELECT    '0000'
                                                                    FROM      dual
                                                                    WHERE     1 = 1
                                                                    AND       :p_id_departamento IS NOT NULL
                                                                  )
                                               OR gcc.segment3 IN (
                                                                    SELECT    '0000'
                                                                    FROM      dual
                                                                    WHERE     1 = 1
                                                                    AND       :p_id_distrito IS NOT NULL
                                                                  )
                                              )
                                    --
                                    AND       EXISTS (
                                                        SELECT    NULL
                                                        FROM      xx_cuentas xc
                                                        WHERE     1 = 1
                                                        AND       xc.segment4 = gcc.segment4
                                                     )
                                    --
                                    GROUP BY  gcc.segment3
                                            , gp.period_num
                                            , gp.period_year
                                    --
                                    --
                                    --
                                    --
                                    --
                                    UNION ALL
                                    SELECT    SUM(xb.budget_amount) montos
                                            , xba.segment_value3 segment3
                                            , xcps.period_num
                                            , xcps.period_year
                                            , 'B' actual_flag
                                    FROM      xcc_balances xb
                                            , xcc_control_budgets xcb
                                            , xcc_cb_period_statuses xcps
                                            , xcc_budget_accounts xba
                                    WHERE     1 = 1
                                    AND       xb.control_budget_id = xcb.control_budget_id
                                    AND       xcb.currency_code = 'MXN'
                                    AND       xb.control_budget_id = xcps.control_budget_id
                                    AND       xb.period_name = xcps.period_name
                                    --AND       xcps.period_num = 1
                                    --AND       xcps.period_year = 2021
                                    AND       xcps.period_num BETWEEN DECODE (  :p_acumulado
                                                                               , 'Y'
                                                                               , 1
                                                                               , :p_period_num
                                                                              ) AND :p_period_num
                                    AND       xcps.period_year IN (:p_anio_anterior, :p_anio_actual)
                                    AND       xb.budget_ccid = xba.budget_code_combination_id
                                    --AND       xba.segment_value1 = '0100'
                                    --AND       xba.segment_value3 = '0008'
                                    --AND       xba.segment_value4 = '6002001'
                                    --
                                    AND       (
                                                    (    :p_tipo_balance IN ('STAFF DIRECTO', 'STAFF INDIRECTO')
                                                     AND xba.segment_value1 IN (
                                                                                SELECT    ffvv.flex_value   segment1
                                                                                FROM      fun_all_business_units_v fabu
                                                                                        , hr_legal_entities        hle
                                                                                        , gl_ledgers               gl
                                                                                        , fnd_flex_values_vl       ffvv
                                                                                        , fnd_id_flex_segments_vl  fifsv
                                                                                        , gl_ledger_segment_values glsv
                                                                                WHERE     1 = 1
                                                                                AND       fabu.status = 'A'
                                                                                AND       fabu.legal_entity_id = hle.legal_entity_id
                                                                                AND       hle.classification_code = 'HCM_LEMP'
                                                                                AND       hle.status = 'A'
                                                                                AND       hle.organization_id = :p_organization_id 
                                                                                AND       fabu.primary_ledger_id = gl.ledger_id
                                                                                AND       gl.chart_of_accounts_id = fifsv.id_flex_num
                                                                                AND       fifsv.id_flex_code = 'GL#'
                                                                                AND       fifsv.enabled_flag = 'Y'
                                                                                AND       UPPER(fifsv.application_column_name) = 'SEGMENT1'
                                                                                AND       fifsv.flex_value_set_id = ffvv.flex_value_set_id
                                                                                AND       ffvv.enabled_flag = 'Y'
                                                                                AND       ffvv.flex_value = glsv.segment_value
                                                                                AND       fabu.legal_entity_id = glsv.legal_entity_id
                                                                                AND       gl.ledger_id = glsv.ledger_id 
                                                                                AND       TRUNC(SYSDATE) BETWEEN hle.effective_start_date AND hle.effective_end_date
                                                                                AND       EXISTS (
                                                                                                    SELECT    NULL
                                                                                                    FROM      (
                                                                                                                SELECT    emp_ven.empresa
                                                                                                                        , emp_ven.empresa_nomina 
                                                                                                                        , regexp_substr(emp_ven.empresa_venta, '[^~]+', 1, level) empresa_venta
                                                                                                                FROM      (
                                                                                                                            SELECT    emp_nom.empresa
                                                                                                                                    , regexp_substr(emp_nom.empresa_nomina, '[^~]+', 1, level) empresa_nomina
                                                                                                                                    , emp_nom.empresa_venta
                                                                                                                            FROM      (
                                                                                                                                        SELECT    flv.meaning empresa
                                                                                                                                                , flv.description empresa_nomina
                                                                                                                                                , flv.tag||'~' empresa_venta
                                                                                                                                        FROM      fnd_lookup_values flv
                                                                                                                                        WHERE     flv.lookup_type = 'XXTOKS_PLANTILLA_VS_VENTA'
                                                                                                                                        AND       flv.language = USERENV('LANG')
                                                                                                                                        AND       flv.meaning = fabu.bu_name 
                                                                                                                                      ) emp_nom
                                                                                                                            CONNECT BY level <= LENGTH(regexp_replace(emp_nom.empresa_nomina, '[^~]+')) + 1
                                                                                                                          ) emp_ven
                                                                                                                CONNECT BY level <= LENGTH(regexp_replace(emp_ven.empresa_venta, '[^~]+')) + 1
                                                                                                              ) venta_nomina
                                                                                                    WHERE     1 = 1
                                                                                                    AND       venta_nomina.empresa_venta IS NOT NULL
                                                                                                    AND       venta_nomina.empresa_nomina = fabu.bu_name 
                                                                                                  )
                                                                              )
                                                    )
                                                 OR (    :p_tipo_balance = 'VENTAS'
                                                     AND xba.segment_value1 IN (
                                                                                SELECT    ffvv.flex_value   segment1
                                                                                FROM      fun_all_business_units_v fabu
                                                                                        , gl_ledgers               gl
                                                                                        , fnd_flex_values_vl       ffvv
                                                                                        , fnd_id_flex_segments_vl  fifsv
                                                                                        , gl_ledger_segment_values glsv
                                                                                WHERE     1 = 1
                                                                                AND       fabu.status = 'A'
                                                                                AND       fabu.primary_ledger_id = gl.ledger_id
                                                                                AND       gl.chart_of_accounts_id = fifsv.id_flex_num
                                                                                AND       fifsv.id_flex_code = 'GL#'
                                                                                AND       fifsv.enabled_flag = 'Y'
                                                                                AND       UPPER(fifsv.application_column_name) = 'SEGMENT1'
                                                                                AND       fifsv.flex_value_set_id = ffvv.flex_value_set_id
                                                                                AND       ffvv.enabled_flag = 'Y'
                                                                                AND       ffvv.flex_value = glsv.segment_value
                                                                                AND       fabu.legal_entity_id = glsv.legal_entity_id
                                                                                AND       gl.ledger_id = glsv.ledger_id 
                                                                                AND EXISTS (
                                                                                            SELECT    NULL
                                                                                            FROM      (
                                                                                                        SELECT    emp_ven.empresa
                                                                                                                , emp_ven.empresa_nomina 
                                                                                                                , regexp_substr(emp_ven.empresa_venta, '[^~]+', 1, level) empresa_venta
                                                                                                        FROM      (
                                                                                                                    SELECT    emp_nom.empresa
                                                                                                                            , regexp_substr(emp_nom.empresa_nomina, '[^~]+', 1, level) empresa_nomina
                                                                                                                            , emp_nom.empresa_venta
                                                                                                                    FROM      (
                                                                                                                                SELECT    flv.meaning empresa
                                                                                                                                        , flv.description empresa_nomina
                                                                                                                                        , flv.tag||'~' empresa_venta
                                                                                                                                FROM      fnd_lookup_values flv
                                                                                                                                WHERE     1 = 1
                                                                                                                                AND       flv.lookup_type = 'XXTOKS_PLANTILLA_VS_VENTA'
                                                                                                                                AND       flv.language = USERENV('LANG')
                                                                                                                                AND       flv.meaning  IN (
                                                                                                                                                            SELECT    fabu2.bu_name
                                                                                                                                                            FROM      hr_legal_entities hle
                                                                                                                                                                    , fun_all_business_units_v fabu2
                                                                                                                                                                    , gl_ledgers gl
                                                                                                                                                            WHERE     1 = 1
                                                                                                                                                            AND       hle.organization_id = :p_organization_id
                                                                                                                                                            AND       hle.classification_code = 'HCM_LEMP'
                                                                                                                                                            AND       hle.status = 'A'
                                                                                                                                                            AND       hle.legal_entity_id = fabu2.legal_entity_id 
                                                                                                                                                            AND       fabu2.status = 'A'
                                                                                                                                                            AND       fabu2.profit_center_flag = 'Y'
                                                                                                                                                            AND       gl.ledger_id = fabu2.primary_ledger_id 
                                                                                                                                                            AND       TRUNC (SYSDATE) BETWEEN hle.effective_start_date AND hle.effective_end_date
                                                                                                                                                          )
                                                                                                                              ) emp_nom
                                                                                                                    CONNECT BY level <= LENGTH(regexp_replace(emp_nom.empresa_nomina, '[^~]+')) + 1
                                                                                                                  ) emp_ven
                                                                                                        CONNECT BY level <= LENGTH(regexp_replace(emp_ven.empresa_venta, '[^~]+')) + 1
                                                                                                      ) venta_nomina
                                                                                            WHERE     1 = 1
                                                                                            AND       venta_nomina.empresa_venta IS NOT NULL
                                                                                            AND       venta_nomina.empresa_venta = fabu.bu_name 
                                                                                           )
                                                                             )
                                                    )
                                              )
                                    --
                                    AND       (   xba.segment_value3 = NVL(:p_unidad, xba.segment_value3)
                                               OR xba.segment_value3 IN (
                                                                            SELECT    '0000'
                                                                            FROM      dual
                                                                            WHERE     1 = 1
                                                                            AND       :p_id_departamento IS NOT NULL
                                                                        )
                                               OR xba.segment_value3 IN (
                                                                            SELECT    '0000'
                                                                            FROM      dual
                                                                            WHERE     1 = 1
                                                                            AND       :p_id_distrito IS NOT NULL
                                                                        )
                                              )
                                    --
                                    AND       EXISTS (
                                                        SELECT    NULL
                                                        FROM      xx_cuentas xc
                                                        WHERE     1 = 1
                                                        AND       xc.segment4 = xba.segment_value4
                                                     )
                                    --
                                    --
                                    GROUP BY  xba.segment_value3
                                            , xcps.period_num
                                            , xcps.period_year
                                  )
                        GROUP BY  segment3
                                , period_num
                                , period_year
                                , actual_flag
                      )
            GROUP BY  segment3
                    , period_num
          )
WHERE     1 = 1
ORDER BY  segment3
